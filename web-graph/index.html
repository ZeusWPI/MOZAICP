<!doctype html>
<html>

<head>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <title>Vis Network | Node Styles | HTML in Nodes</title>

    <style type="text/css">
        body {
            font: 10pt arial;
        }
        
        #mynetwork {
            width: 600px;
            height: 600px;
            border: 1px solid lightgray;
            background-color: #eeeeee;
        }
    </style>

    <script type="text/javascript">
        var data = new vis.DataSet();

        var nodes = null;
        var edges = null;
        var network = null;
        // Called when the Visualization API is loaded.
        function draw() {}
    </script>

</head>

<body onload="draw()">
    <div style="width: 80vw; height: 80vh; margin: auto;" id="mynetwork"></div>

    <script>
        var nodes = new vis.DataSet();
        var edges = new vis.DataSet();

        var colour_cache = {};

        // TODO add colour

        nodes.add({
            id: 1,
            label: 'Get HTML'
        });
        nodes.add({
            id: 2,
            label: 'Using SVG'
        });
        nodes.add({
            id: 3,
            label: 'Using SVG'
        });
        nodes.add({
            id: 4,
            label: 'Using SVG'
        });

        edges.add({
            id: 1,
            from: 1,
            to: 2,
            length: 300
        });

        function random_colour() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function set_color(nodes) {
            nodes = Array.isArray(nodes) ? nodes : [nodes];
            for (let n of nodes) {
                if (colour_cache[n.label] == undefined) {
                    colour_cache[n.label] = random_colour();
                }
                n.color = colour_cache[n.label];
            }
        }

        /*

        Event: {
            type: string,
        }

        Event: {
            type: "init",
            nodes: [{
                id: int,
                label: string
            }],
            edges: [{
                id: int,
                from: int,
                to: int
            }]
        }

        Event: {
            type: "add",
            data_type: "node",
            data:  {
                id: int,
                label: string
            }
        }

        Event: {
            type: "add",
            data_type: "edge",
            data:  {
                id: int,
                from: int,
                to: int
            }
        }

        Event: {
            type: "remove",
            data_type: "edge"|"node",
            id: int
        }

        */
        function handle_event(event) {
            if (event.type === "Init") {
                nodes.clear();
                edges.clear();
                set_color(event.nodes);

                nodes.add(event.nodes);

                setTimeout(
                    () => {
                        edges.add(event.edges);
                    }, 200
                )
            } else {
                const at = event.data_type === "Node" ? nodes : edges;


                if (event.type === "Add") {
                    if (event.data_type === "Node") {
                        set_color(event.data);
                    }
                    at.add(event.data);
                } else {
                    at.remove(event.id);
                }
            }
        }

        function draw() {
            const container = document.getElementById('mynetwork');

            const data = {
                nodes: nodes,
                edges: edges
            };
            const options = {
                physics: {
                    forceAtlas2Based: {
                        centralGravity: 0.02,
                        damping: 0.0
                    },
                    timestamp: 0.2
                }
            };

            const network = new vis.Network(container, data, options);

            var ws = new WebSocket('ws://127.0.0.1:3012');
            ws.onmessage = function(event) {
                console.log(event.data);
                handle_event(JSON.parse(event.data));
            };
        }
    </script>
</body>

</html>